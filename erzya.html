<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ärźaň čat</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html,
    body {
      height: 100%;
      margin: 0;
      padding: 0;
    }

    body {
      background: #0f1b2d;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100%;
    }

    .chat-container {
      background: #17212b;
      border-radius: 12px;
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
      width: 100%;
      max-width: 400px;
      height: 85vh;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    h2 {
      text-align: center;
      color: #e1e8f0;
      font-size: 1.2rem;
      font-weight: 500;
      margin-bottom: 5px;
    }

    #messages {
      flex: 1 1 auto;
      border-radius: 8px;
      padding: 16px 16px 0 16px;
      overflow-y: auto;
      background: #0f1b2d;
      min-height: 0;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .message {
      font-size: 0.95rem;
      line-height: 1.4;
      background: #2b5278;
      color: #ffffff;
      padding: 8px 12px;
      border-radius: 12px;
      margin-bottom: 2px;
      word-wrap: break-word;
      white-space: normal;
      width: fit-content;
      max-width: 90%;
      position: relative;
      align-self: flex-end;
      border-bottom-right-radius: 4px;
    }

    #messages>[data-key] {
      display: flex;
      width: 100%;
    }

    #messages>[data-key]:has(.delete-btn) {
      justify-content: flex-end;
    }

    #messages>[data-key]:not(:has(.delete-btn)) {
      justify-content: flex-start;
    }

    [data-key] .message:not(:has(.delete-btn)) {
      background: #2d3b4d;
      color: #e1e8f0;
      align-self: flex-start;
      border-bottom-left-radius: 4px;
      border-bottom-right-radius: 12px;
    }

    [data-key] .message:has(.delete-btn) {
      position: relative;
    }

    .nickname {
      display: block;
      margin-bottom: 4px;
      font-size: 0.75rem;
      color: #7fd4ff;
      font-weight: 500;
    }

    [data-key] .message:not(:has(.delete-btn)) .nickname {
      color: #6ab3f3;
    }

    .timestamp {
      font-size: 0.7rem;
      color: #a8c7e0;
      margin-top: 4px;
      text-align: right;
      opacity: 0.8;
    }

    [data-key] .message:not(:has(.delete-btn)) .timestamp {
      color: #8a9aa9;
      text-align: left;
    }

    .delete-btn {
      position: absolute;
      top: 4px;
      left: -32px;
      background: none !important;
      border: none;
      color: #8a9aa9;
      cursor: pointer;
      font-size: 0.9rem;
      padding: 2px;
      outline: none;
      transition: color 0.2s;
    }

    .delete-btn:hover,
    .delete-btn:focus {
      background: none !important;
      outline: none;
      box-shadow: none;
      color: #ff6b6b;
    }

    .input-group {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    .input-group button {
      margin-left: 0;
    }

    #nicknameInput {
      padding: 12px;
      background: #242f3d;
      border: 1px solid #2d3b4d;
      border-radius: 8px;
      color: #e1e8f0;
      font-size: 0.95rem;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
    }

    #nicknameInput::placeholder {
      color: #6b7b8d;
    }

    #messageInput {
      flex-grow: 1;
      padding: 12px;
      background: #242f3d;
      border: 1px solid #2d3b4d;
      border-radius: 8px;
      outline: none;
      font-size: 0.95rem;
      resize: none;
      overflow-y: auto;
      white-space: pre-wrap;
      word-break: break-word;
      min-height: 50px;
      max-height: 120px;
      color: #e1e8f0;
      font-family: inherit;
      -webkit-overflow-scrolling: touch;
      touch-action: manipulation;
      overscroll-behavior: contain;
    }

    #messageInput::placeholder {
      color: #6b7b8d;
    }

    #messageInput:focus {
      border-color: #3d8fd1;
    }

    button {
      font-family: inherit;
      font-size: 0.95rem;
      background: #2b5278;
      color: #ffffff;
      border: none;
      padding: 12px 20px;
      max-height: fit-content;
      margin: auto;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s;
      font-weight: 500;
    }

    button:hover {
      background: #3d8fd1;
    }

    button:active {
      background: #2b5278;
      transform: translateY(1px);
    }

    .room-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    .room-header select {
      flex-grow: 1;
      padding: 10px;
      border-radius: 8px;
      background-color: #242f3d;
      border: 1px solid #2d3b4d;
      font-family: inherit;
      font-size: 0.95rem;
      width: 100%;
      color: #e1e8f0;
      cursor: pointer;
    }

    .room-header select:focus {
      border-color: #3d8fd1;
      outline: none;
    }

    .room-header .flag {
      height: 100%;
      max-height: 40px;
      width: auto;
      object-fit: contain;
      border: 1px solid #2d3b4d;
      border-radius: 8px;
    }

    #messages::-webkit-scrollbar {
      width: 6px;
    }

    #messages::-webkit-scrollbar-track {
      background: #0f1b2d;
      border-radius: 3px;
    }

    #messages::-webkit-scrollbar-thumb {
      background: #2d3b4d;
      border-radius: 3px;
    }

    #messages::-webkit-scrollbar-thumb:hover {
      background: #3d4d60;
    }

    #messageInput::-webkit-scrollbar {
      width: 4px;
    }

    #messageInput::-webkit-scrollbar-track {
      background: #242f3d;
      border-radius: 2px;
    }

    #messageInput::-webkit-scrollbar-thumb {
      background: #2d3b4d;
      border-radius: 2px;
    }

    @media (max-width: 480px) {

      html,
      body {
        height: 100%;
        margin: 0;
        padding: 0;
      }

      body {
        background: #0f1b2d;
        padding: 0;
        justify-content: flex-start;
        align-items: stretch;
      }

      .chat-container {
        padding: 15px;
        gap: 12px;
        height: 100vh;
        border-radius: 0;
        max-width: none;
        box-shadow: none;
      }

      h2 {
        font-size: 1.1rem;
        margin-bottom: 0;
      }

      #messages {
        padding: 16px 16px 0 16px;
        gap: 6px;
      }

      .message {
        font-size: 0.9rem;
        padding: 8px 10px;
        max-width: 90%;
      }

      .nickname {
        font-size: 0.7rem;
      }

      .timestamp {
        font-size: 0.65rem;
      }

      #messageInput,
      #nicknameInput {
        font-size: 0.9rem;
        padding: 10px;
      }

      #messageInput {
        min-height: 45px;
        max-height: 100px;
      }

      button {
        padding: 10px 16px;
        font-size: 0.9rem;
      }

      .input-group {
        gap: 8px;
      }

      .room-header {
        margin-bottom: 8px;
      }

      .room-header select {
        font-size: 0.9rem;
        padding: 10px;
      }
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(5px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message {
      animation: fadeIn 0.2s ease-out;
    }
  </style>
</head>

<body>
  <div class="chat-container">
    <h2>Uralic chats</h2>
    <div class="room-header">
      <img src="Erzya_Flag.svg" class="flag" alt="Erzya Flag" />
      <select id="roomSelect" onchange="location = this.value;">
        <option value="erzya.html">Ärźaň čat</option>
        <option value="#">Мокшень чатсь</option>
      </select>
    </div>

    <input id="nicknameInput" type="text" placeholder="Koda lämet?" />
    <div id="messages"></div>
    <div class="input-group">
      <textarea id="messageInput" placeholder="Śormadt tago-mäze..."></textarea>
      <button onclick="sendMessage()">Kučoma</button>
    </div>
  </div>

  <audio id="sendSound" src="send.mp3" preload="auto"></audio>
  <audio id="receiveSound" src="receive.mp3" preload="auto"></audio>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCpOs1A0F1cZwLDnmIJhEbGQWpC37ldPwg",
      authDomain: "uralic-chat.firebaseapp.com",
      projectId: "uralic-chat",
      storageBucket: "uralic-chat.firebasestorage.app",
      messagingSenderId: "651022382636",
      appId: "1:651022382636:web:55a4977844994c9c26c389"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const messagesRef = db.ref("messages");

    const userId = localStorage.getItem('userId') || generateUserId();
    localStorage.setItem('userId', userId);

    const nicknameInput = document.getElementById("nicknameInput");
    nicknameInput.value = localStorage.getItem('nickname') || '';

    nicknameInput.addEventListener('change', () => {
      localStorage.setItem('nickname', nicknameInput.value);
    });

    function generateUserId() {
      return 'user_' + Math.random().toString(36).substr(2, 9);
    }

    function sendMessage() {
      const msg = document.getElementById("messageInput").value;
      const nickname = nicknameInput.value.trim() || "Asodaviks";
      if (msg.trim()) {
        messagesRef.push({
          text: msg,
          userId: userId,
          nickname: nickname,
          timestamp: Date.now()
        });
        document.getElementById("messageInput").value = '';
      }
      if (sendSound) sendSound.play();
    }

    document.getElementById("messageInput").addEventListener("keydown", (e) => {
      return;

      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    messagesRef.on("child_added", (snapshot) => {
      const data = snapshot.val();
      if (data.userId !== userId) {
        if (receiveSound) receiveSound.play();
      }
      const container = document.createElement("div");
      container.style.position = "relative";

      const div = document.createElement("div");
      div.className = "message";

      const nicknameSpan = document.createElement("span");
      nicknameSpan.className = "nickname";
      nicknameSpan.textContent = `${data.nickname} śormadś:`;

      const messageText = document.createTextNode(data.text);
      div.appendChild(nicknameSpan);
      div.appendChild(messageText);

      const timeInfo = document.createElement("div");
      timeInfo.className = "timestamp";
      const date = new Date(data.timestamp || Date.now());

      const erzyanMonths = [
        "jakšamkovoň",
        "davolkovoň",
        "eiźurkovoň",
        "čadïkovoň",
        "panžikovoň",
        "aštemkovoň",
        "mädkovoň",
        "umařkovoň",
        "taštamkovoň",
        "ožokovoň",
        "sunderkovoň",
        "acamkovoň"
      ];

      const year = date.getFullYear();
      const month = erzyanMonths[date.getMonth()];
      const day = date.getDate();
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');

      timeInfo.textContent = `${year}-ce ijen ${month} ${day}-ce čistë ${hours}.${minutes}`;
      div.appendChild(timeInfo);

      if (data.userId === userId) {
        const deleteBtn = document.createElement("button");
        deleteBtn.className = "delete-btn";
        deleteBtn.textContent = "✕";
        deleteBtn.title = "Nardams kučovksoňt";
        deleteBtn.onclick = () => {
          if (confirm("Kemestë toň uli melet nardams te kučovksoňt?")) {
            messagesRef.child(snapshot.key).remove();
          }
        };
        div.appendChild(deleteBtn);
      }

      container.setAttribute('data-key', snapshot.key);
      container.appendChild(div);
      document.getElementById("messages").appendChild(container);
      document.getElementById("messages").scrollTop = document.getElementById("messages").scrollHeight;
    });

    messagesRef.on("child_removed", (snapshot) => {
      const msgDiv = document.querySelector(`[data-key='${snapshot.key}']`);
      if (msgDiv) msgDiv.remove();
    });

    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(() => {
        document.getElementById('messageInput').focus();
      }, 100);
    });
  </script>
</body>

</html>
